(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{542:function(a,e,s){"use strict";s.r(e);var t=s(6),r=Object(t.a)({},(function(){var a=this,e=a.$createElement,s=a._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[s("img",{attrs:{src:"https://i.imgur.com/8xF4SUW.jpg",alt:""}})]),a._v(" "),s("h2",{attrs:{id:"what-is-harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#what-is-harbor"}},[a._v("#")]),a._v(" What is Harbor?")]),a._v(" "),s("p",[a._v("Harbor is an open source registry that secures artifacts with policies and role-based access control, ensures images are scanned and free from vulnerabilities, and signs images as trusted. Harbor, a CNCF Graduated project, delivers compliance, performance, and interoperability to help you consistently and securely manage artifacts across cloud native compute platforms like Kubernetes and Docker.")]),a._v(" "),s("h2",{attrs:{id:"harbor-installation-rrerequisites"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#harbor-installation-rrerequisites"}},[a._v("#")]),a._v(" Harbor Installation Rrerequisites")]),a._v(" "),s("p",[a._v("The target host requires Docker, and Docker Compose to be installed.")]),a._v(" "),s("p",[a._v("Please refer to the installation instruction of "),s("a",{attrs:{href:"https://cyb.tw/docs/Tech/2020/8/Install%20Docker%20Dockerhub%20and%20docker%20compose%20on%20Ubuntu.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("this article"),s("OutboundLink")],1),a._v(".")]),a._v(" "),s("h2",{attrs:{id:"download-and-unpack-the-installer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#download-and-unpack-the-installer"}},[a._v("#")]),a._v(" Download and Unpack the Installer")]),a._v(" "),s("ol",[s("li",[a._v("Download the installer form "),s("a",{attrs:{href:"https://github.com/goharbor/harbor/releases",target:"_blank",rel:"noopener noreferrer"}},[a._v("Harbor release page"),s("OutboundLink")],1)]),a._v(" "),s("li",[a._v("unpack the installer:")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" xvf harbor-online-installer-version.tgz\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## or")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" xvf harbor-offline-installer-version.tgz\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("h2",{attrs:{id:"configure-https-access-to-harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-https-access-to-harbor"}},[a._v("#")]),a._v(" Configure HTTPS Access to Harbor")]),a._v(" "),s("ol",[s("li",[a._v("Generate a Certificate Authority Certificate")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## Generate a CA certificate private key")]),a._v("\nopenssl genrsa -out ca.key "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## Generate the CA certificate")]),a._v("\nopenssl req -x509 -new -nodes -sha512 -days "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -subj "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/C=TW/ST=Taipei/L=Taipei/O=example/OU=Personal/CN=yourdomain.com"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -key ca.key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -out ca.crt\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[a._v("Generate a Server Certificate")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## Generate a private key")]),a._v("\nopenssl genrsa -out yourdomain.com.key "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## Generate a certificate signing request (CSR)")]),a._v("\nopenssl req -sha512 -new "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -subj "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/C=TW/ST=Taipei/L=Taipei/O=example/OU=Personal/CN=yourdomain.com"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -key yourdomain.com.key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -out yourdomain.com.csr\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## Generate an x509 v3 extension file.")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" v3.ext "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<-")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=yourdomain.com\nDNS.2=yourdomain\nDNS.3=hostname\nEOF")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br")])]),s("ol",{attrs:{start:"4"}},[s("li",[a._v("Use the "),s("code",[a._v("v3.ext")]),a._v(" file to generate a certificate for your Harbor host.")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("openssl x509 -req -sha512 -days "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -extfile v3.ext "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -CA ca.crt -CAkey ca.key -CAcreateserial "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -in yourdomain.com.csr "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -out yourdomain.com.crt\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("ol",{attrs:{start:"5"}},[s("li",[a._v("Copy the server certificate and key into the certficates folder on your Harbor host.")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" yourdomain.com.crt /data/cert/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" yourdomain.com.key /data/cert/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("ol",{attrs:{start:"6"}},[s("li",[a._v("Convert "),s("code",[a._v("yourdomain.com.crt")]),a._v(" to "),s("code",[a._v("yourdomain.com.cert")]),a._v(", for use by Docker.")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("openssl x509 -inform PEM -in yourdomain.com.crt -out yourdomain.com.cert\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ol",{attrs:{start:"7"}},[s("li",[a._v("Copy the server certificate, key and CA files into the Docker certificates folder on the Harbor host. You must create the appropriate folders first.")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" yourdomain.com.cert /etc/docker/certs.d/yourdomain.com/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" yourdomain.com.key /etc/docker/certs.d/yourdomain.com/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" ca.crt /etc/docker/certs.d/yourdomain.com/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("blockquote",[s("p",[a._v("If you mapped the default nginx port 443 to a different port, create the folder "),s("code",[a._v("/etc/docker/certs.d/yourdomain.com:port")]),a._v(", or "),s("code",[a._v("/etc/docker/certs.d/harbor_IP:port")]),a._v(".")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("/etc/docker/certs.d/\n    └── yourdomain.com:port\n       ├── yourdomain.com.cert  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("-- Server certificate signed by CA\n       ├── yourdomain.com.key   "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("-- Server key signed by CA\n       └── ca.crt               "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("-- Certificate authority that signed the registry certificate\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("ol",{attrs:{start:"8"}},[s("li",[a._v("Restart Docker Engine")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl restart docker\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"configure-the-harbor-yml-file"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-the-harbor-yml-file"}},[a._v("#")]),a._v(" Configure the Harbor YML File")]),a._v(" "),s("ol",[s("li",[a._v("Copy "),s("code",[a._v("harbor.yml.tmpl")]),a._v(" to "),s("code",[a._v("harbor.yml")])])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" harbor.yml.tmpl harbor.yml\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[a._v("Edit and config the "),s("code",[a._v("harbor.yml")]),a._v(" file")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("vi")]),a._v(" harbor.yml\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("Go "),s("a",{attrs:{href:"https://goharbor.io/docs/2.2.0/install-config/configure-yml-file/",target:"_blank",rel:"noopener noreferrer"}},[a._v("here"),s("OutboundLink")],1),a._v(" to read the configuration detail.")]),a._v(" "),s("h2",{attrs:{id:"deploy-or-reconfigure-harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploy-or-reconfigure-harbor"}},[a._v("#")]),a._v(" Deploy or Reconfigure Harbor")]),a._v(" "),s("p",[a._v("Run the script to deploy harbor. Note that it might take some time for the online installer to download all of the Harbor images from Docker hub.")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## Run the prepare script to enable HTTPS.")]),a._v("\n./prepare\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## install and start Harbor")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ./install.sh --with-notary --with-clair\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h2",{attrs:{id:"how-to-restart-the-harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#how-to-restart-the-harbor"}},[a._v("#")]),a._v(" How to restart the Harbor")]),a._v(" "),s("p",[a._v("If the Harbor service occur error, you can try to restart it. Your image data remains in the file system, so no data is lost.")]),a._v(" "),s("ul",[s("li",[a._v("Stop Harbor")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("docker-compose down -v\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("Restart Harbor")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("docker-compose up -d\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"references"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[a._v("#")]),a._v(" References")]),a._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://goharbor.io/docs/2.2.0/install-config/",target:"_blank",rel:"noopener noreferrer"}},[a._v("goharbor doc"),s("OutboundLink")],1)]),a._v(" "),s("li",[s("a",{attrs:{href:"https://ithelp.ithome.com.tw/articles/10223099",target:"_blank",rel:"noopener noreferrer"}},[a._v("ithome - 自建私有容器儲存庫(Container Registry)與實現內容信任(Content Trust)"),s("OutboundLink")],1)]),a._v(" "),s("li",[s("a",{attrs:{href:"https://ithelp.ithome.com.tw/articles/10249640",target:"_blank",rel:"noopener noreferrer"}},[a._v("ithome - 自架 Registry - Harbor"),s("OutboundLink")],1)]),a._v(" "),s("li",[s("a",{attrs:{href:"https://randyou.github.io/2020/07/07/gitlab-jenkins-harbor-k8s/",target:"_blank",rel:"noopener noreferrer"}},[a._v("randyou - Gitlab + Jenkins + Harbor + k8s 实现前端持续集成与部署"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=r.exports}}]);